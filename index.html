<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2196F3">
    <title>ì†ê¸°ì‚¬ ì¼ì • ê´€ë¦¬</title>
    <link rel="manifest" href="manifest.json">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS (ì—‘ì…€) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- OneSignal -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f5f5f5;padding:20px}

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loadingOverlay{display:none;position:fixed;inset:0;background:rgba(255,255,255,.85);z-index:9999;align-items:center;justify-content:center;flex-direction:column;gap:16px}
        #loadingOverlay.show{display:flex}
        .spinner{width:44px;height:44px;border:4px solid #e0e0e0;border-top-color:#2196F3;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        #toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:#333;color:#fff;padding:12px 24px;border-radius:24px;font-size:14px;z-index:9998;transition:transform .3s;white-space:nowrap}
        #toast.show{transform:translateX(-50%) translateY(0)}

        /* ë¡œê·¸ì¸ */
        .login-container{max-width:400px;margin:80px auto;background:#fff;border-radius:12px;padding:40px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .login-header{text-align:center;margin-bottom:30px}
        .login-header h1{color:#333;font-size:24px;margin-bottom:8px}
        .login-header p{color:#666;font-size:14px}
        .login-form{display:flex;flex-direction:column;gap:20px}
        .form-group{margin-bottom:0}
        .form-group label{display:block;margin-bottom:8px;color:#666;font-weight:500;font-size:14px}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#2196F3}
        .form-group textarea{resize:vertical;min-height:80px}
        .login-btn{padding:13px;background:#2196F3;color:#fff;border:none;border-radius:6px;font-size:16px;font-weight:500;cursor:pointer;transition:background .2s}
        .login-btn:hover{background:#0b7dda}
        .error-message{background:#ffebee;color:#c62828;padding:10px;border-radius:6px;font-size:14px;margin-bottom:15px;display:none}
        .error-message.show{display:block}
        .demo-accounts{margin-top:24px;padding-top:20px;border-top:1px solid #e0e0e0;font-size:12px;color:#999}
        .demo-accounts p{margin-bottom:6px}

        /* ë©”ì¸ */
        .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:12px;padding:30px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #e0e0e0;gap:16px;flex-wrap:wrap}
        .header-left h1{color:#333;font-size:24px;margin-bottom:4px}
        .welcome-message{color:#666;font-size:14px}
        .header-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .user-toggle{display:flex;gap:8px;flex-wrap:wrap}
        .superadmin-badge{background:#7c3aed;color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;margin-left:6px;vertical-align:middle}
        .admin-badge{background:#1976d2;color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;margin-left:6px;vertical-align:middle}

        /* ê²€ìƒ‰ */
        .search-wrap{display:flex;align-items:center;gap:8px;margin-bottom:16px}
        .search-input{flex:1;padding:10px 14px;border:1px solid #ddd;border-radius:24px;font-size:14px;outline:none;transition:border-color .2s}
        .search-input:focus{border-color:#2196F3}
        .search-clear{background:none;border:none;color:#999;cursor:pointer;font-size:18px;padding:4px;line-height:1}

        /* ë²„íŠ¼ */
        .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-size:14px;transition:all .2s;white-space:nowrap}
        .btn-primary{background:#4CAF50;color:#fff}
        .btn-primary:hover{background:#45a049}
        .btn-secondary{background:#2196F3;color:#fff}
        .btn-secondary:hover{background:#0b7dda}
        .btn-outline{background:#fff;color:#666;border:1px solid #ddd}
        .btn-outline:hover{background:#f5f5f5}
        .btn-outline.active{background:#2196F3;color:#fff;border-color:#2196F3}
        .btn-logout{background:#f44336;color:#fff}
        .btn-logout:hover{background:#d32f2f}
        .btn-danger{background:#f44336;color:#fff}
        .btn-danger:hover{background:#d32f2f}
        .btn-purple{background:#7c3aed;color:#fff}
        .btn-purple:hover{background:#6d28d9}

        /* í†µê³„ */
        .stats{display:flex;gap:16px;margin-bottom:20px}
        .stat-card{flex:1;background:#f5f5f5;padding:15px;border-radius:8px;text-align:center}
        .stat-number{font-size:24px;font-weight:700;color:#2196F3}
        .stat-label{font-size:12px;color:#666;margin-top:4px}

        /* í•„í„° */
        .filter-section{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}

        /* ìº˜ë¦°ë” */
        .calendar{margin:20px 0}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .calendar-month{font-size:20px;font-weight:700;color:#333}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
        .calendar-day-header{text-align:center;padding:10px;font-weight:700;color:#666;font-size:14px}
        .calendar-day{border:1px solid #e0e0e0;border-radius:8px;padding:8px;cursor:pointer;transition:all .2s;min-height:80px;position:relative}
        .calendar-day:hover{background:#f5f5f5;border-color:#2196F3}
        .calendar-day.has-event{background:#e3f2fd;border-color:#2196F3}
        .calendar-day.today{border-color:#ff9800;border-width:2px}
        .day-number{font-size:14px;color:#333;margin-bottom:4px}
        .day-number.today-num{color:#ff9800;font-weight:700}
        .event-dot{width:6px;height:6px;background:#2196F3;border-radius:50%;display:inline-block;margin-right:3px}
        .event-preview{font-size:11px;color:#555;margin-top:4px;line-height:1.4}

        /* ì¼ì • ëª©ë¡ */
        .schedule-list{margin-top:24px}
        .schedule-item{background:#f9f9f9;border-left:4px solid #2196F3;padding:15px;margin-bottom:12px;border-radius:6px}
        .schedule-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .schedule-title{font-weight:700;color:#333;font-size:16px}
        .schedule-date{color:#666;font-size:14px}
        .freelancer-view .schedule-item{border-left-color:#4CAF50}
        .action-buttons{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
        .status-badge{padding:4px 12px;border-radius:12px;font-size:12px;font-weight:700}
        .status-unconfirmed{background:#ffebee;color:#c62828}
        .status-confirmed{background:#fff3e0;color:#ef6c00}
        .status-completed{background:#e8f5e9;color:#2e7d32}

        /* ëª¨ë‹¬ */
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
        .modal.show{display:flex}
        .modal-content{background:#fff;border-radius:12px;padding:30px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
        .modal-content.wide{max-width:700px}
        .modal-header{font-size:20px;font-weight:700;margin-bottom:20px;color:#333;display:flex;justify-content:space-between;align-items:center}
        .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#666;line-height:1}

        /* íšŒì›ê´€ë¦¬ ì¹´ë“œ */
        .user-card{background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
        .user-card-info{flex:1;min-width:200px}
        .user-card-name{font-weight:700;color:#333;font-size:16px;margin-bottom:4px}
        .user-card-meta{color:#666;font-size:14px;line-height:1.6}
        .user-card-actions{display:flex;gap:8px;flex-wrap:wrap}
        .role-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;margin-left:6px}
        .role-superadmin{background:#ede9fe;color:#6d28d9}
        .role-admin{background:#dbeafe;color:#1d4ed8}
        .role-freelancer{background:#dcfce7;color:#166534}

        /* ì˜¤ëŠ˜ ì¼ì • íŒ¨ë„ */
        #todaySchedules{background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:15px;margin-bottom:20px}
        #todayScheduleList{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
        .today-card{background:#f9f9f9;border-radius:6px;padding:10px 12px;flex:1;min-width:260px;display:flex;align-items:center;gap:8px}

        /* ì†ê¸°ì‚¬ ìš”ì•½ */
        #freelancerSummary{display:none;background:#f0f7ff;border:2px solid #2196F3;border-radius:8px;padding:15px;margin-bottom:20px}

        /* ë‚ ì§œ ë²”ìœ„ í•„í„° */
        .date-range-bar{background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:14px;margin-bottom:14px}
        .date-range-bar>div{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

        /* ì•„ì½”ë””ì–¸ */
        @keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}

        /* ì¼ê´„ ë‚ ì§œ ì„ íƒ */
        #bulkDateSelector{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}

        /* ë°˜ì‘í˜• */
        @media(max-width:768px){
            body{padding:10px}
            .container{padding:16px 12px;border-radius:8px}
            .login-container{margin:40px auto;padding:28px 20px}
            .header{flex-direction:column;gap:12px}
            .header-right{flex-direction:column;width:100%}
            .user-toggle{width:100%;justify-content:center}
            .user-toggle .btn{flex:1;padding:12px;font-size:15px}
            .btn-logout{width:100%;padding:12px;font-size:15px}
            .stats{flex-wrap:wrap;gap:8px}
            .stat-card{min-width:calc(50% - 4px);padding:12px}
            .stat-number{font-size:20px}
            .filter-section .btn{flex:1 1 calc(50% - 4px);padding:10px 8px;font-size:13px}
            .calendar-grid{gap:4px}
            .calendar-day{min-height:56px;padding:5px}
            .calendar-day-header{font-size:12px;padding:8px 4px}
            .day-number{font-size:12px}
            .event-preview{font-size:9px}
            .event-dot{width:4px;height:4px}
            .action-buttons{flex-direction:column}
            .action-buttons .btn{width:100%;padding:12px}
            .modal-content{width:96%;padding:22px 16px;max-height:88vh}
            .modal-content.wide{max-width:96%}
            .schedule-header{flex-direction:column;align-items:flex-start;gap:6px}
            .form-group input,.form-group select,.form-group textarea{font-size:16px;padding:12px}
            .stats .stat-card:nth-child(3),.stats .stat-card:nth-child(4){margin-top:0}
            h1{font-size:20px}
            .date-range-bar>div{gap:6px}
            .date-range-bar .btn{flex:1;font-size:12px;padding:8px 6px}
            #adminFreelancerSelect{width:100%;padding:12px;font-size:15px}
            .today-card{min-width:100%}
            .search-wrap{margin-bottom:12px}
            .user-card{flex-direction:column}
        }
        @media(max-width:360px){
            .container{padding:12px 8px}
            .stat-card{min-width:100%}
            .filter-section .btn{flex:1 1 100%}
            .calendar-day{min-height:46px;padding:3px}
            .day-number{font-size:11px}
        }
    </style>
</head>
<body>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay"><div class="spinner"></div><div style="color:#666;font-size:14px">ì²˜ë¦¬ ì¤‘...</div></div>
<!-- í† ìŠ¤íŠ¸ -->
<div id="toast"></div>

<!-- ë¡œê·¸ì¸ í™”ë©´ -->
<div id="loginScreen" class="login-container" style="display:none">
    <div class="login-header">
        <h1>ì†ê¸°ì‚¬ í˜„ì¥ì†ê¸° ì¼ì • ê´€ë¦¬</h1>
        <p>ë¡œê·¸ì¸í•˜ì—¬ ì¼ì •ì„ í™•ì¸í•˜ì„¸ìš”</p>
    </div>
    <div class="error-message" id="loginError"></div>
    <form class="login-form" onsubmit="handleLogin(event)">
        <div class="form-group"><label>ì•„ì´ë”” (ì´ë¦„)</label><input type="text" id="loginUsername" required placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username"></div>
        <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="loginPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="current-password"></div>
        <button type="submit" class="login-btn" id="loginBtn">ë¡œê·¸ì¸</button>
    </form>
    <div style="text-align:center;margin-top:14px">
        <button onclick="showSignupScreen()" style="background:none;border:none;color:#2196F3;cursor:pointer;text-decoration:underline;font-size:14px">ì†ê¸°ì‚¬ íšŒì›ê°€ì…</button>
    </div>
    <div class="demo-accounts">
        <p><strong>ë¡œê·¸ì¸ ë°©ì‹:</strong> ì´ë¦„(í•œê¸€) + ë¹„ë°€ë²ˆí˜¸</p>
        <p>ê´€ë¦¬ì ê³„ì •ì€ Supabaseì—ì„œ ì§ì ‘ ìƒì„±í•©ë‹ˆë‹¤.</p>
    </div>
</div>

<!-- íšŒì›ê°€ì… í™”ë©´ -->
<div id="signupScreen" class="login-container" style="display:none">
    <div class="login-header">
        <h1>ì†ê¸°ì‚¬ íšŒì›ê°€ì…</h1>
        <p>ê°€ì… ì‹ ì²­ í›„ ê´€ë¦¬ì ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
    </div>
    <div class="error-message" id="signupError"></div>
    <form class="login-form" onsubmit="handleSignup(event)">
        <div class="form-group"><label>ì´ë¦„ (ë¡œê·¸ì¸ ì•„ì´ë””ë¡œ ì‚¬ìš©)</label><input type="text" id="signupName" required placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></div>
        <div class="form-group"><label>ì „í™”ë²ˆí˜¸</label><input type="tel" id="signupPhone" required placeholder="010-1234-5678"></div>
        <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="signupPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)"></div>
        <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input type="password" id="signupPasswordConfirm" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"></div>
        <button type="submit" class="login-btn">ê°€ì… ì‹ ì²­</button>
    </form>
    <div style="text-align:center;margin-top:14px">
        <button onclick="showLoginScreen()" style="background:none;border:none;color:#666;cursor:pointer;text-decoration:underline;font-size:14px">ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<!-- ê°€ì… ì„±ê³µ í™”ë©´ -->
<div id="signupSuccessScreen" class="login-container" style="display:none">
    <div style="text-align:center;padding:40px 20px">
        <div style="font-size:48px;margin-bottom:20px">âœ…</div>
        <h2 style="color:#333;margin-bottom:14px">ê°€ì… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
        <p style="color:#666;font-size:15px;line-height:1.7">ë‹´ë‹¹ì í™•ì¸ í›„ ìŠ¹ì¸ë  ì˜ˆì •ì…ë‹ˆë‹¤.<br>ìŠ¹ì¸ ì™„ë£Œ ì‹œ ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        <button class="btn btn-primary" onclick="showLoginScreen()" style="margin-top:28px;width:100%;padding:14px;font-size:16px">í™•ì¸</button>
    </div>
</div>

<!-- ë©”ì¸ í™”ë©´ -->
<div id="mainScreen" class="container" style="display:none">
    <div class="header">
        <div class="header-left">
            <h1 id="pageTitle">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
            <div class="welcome-message" id="welcomeMessage"></div>
        </div>
        <div class="header-right">
            <div class="user-toggle" id="viewToggle">
                <button class="btn btn-outline active" onclick="switchView('admin')">ê´€ë¦¬ì</button>
                <button class="btn btn-outline" onclick="switchView('freelancer')">í”„ë¦¬ëœì„œ</button>
                <button class="btn btn-outline" onclick="switchView('users')">íšŒì› ê´€ë¦¬</button>
                <button class="btn btn-purple" id="adminMgmtTab" onclick="switchView('admins')" style="display:none">ê´€ë¦¬ì ê´€ë¦¬</button>
            </div>
            <button class="btn btn-logout" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì í™”ë©´ -->
    <div id="adminView">
        <!-- ê²€ìƒ‰ -->
        <div class="search-wrap">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” íšŒì˜ëª… ë˜ëŠ” ì†ê¸°ì‚¬ëª… ê²€ìƒ‰..." oninput="handleSearch(this.value)">
            <button class="search-clear" onclick="clearSearch()" title="ê²€ìƒ‰ ì´ˆê¸°í™”">âœ•</button>
        </div>

        <!-- í†µê³„ + ë²„íŠ¼ -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:20px;flex-wrap:wrap">
            <div class="stats" style="margin-bottom:0;flex:1;min-width:280px">
                <div class="stat-card"><div class="stat-number" id="totalSchedules">0</div><div class="stat-label">ì´ ì¼ì •</div></div>
                <div class="stat-card"><div class="stat-number" id="unconfirmedCount">0</div><div class="stat-label">ë¯¸í™•ì¸</div></div>
                <div class="stat-card"><div class="stat-number" id="confirmedCount">0</div><div class="stat-label">í™•ì¸ ì™„ë£Œ</div></div>
                <div class="stat-card"><div class="stat-number" id="completedCount">0</div><div class="stat-label">ì°¸ì„ ì™„ë£Œ</div></div>
            </div>
            <div style="display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="openAddScheduleModal()">+ ìƒˆ ì¼ì • ë“±ë¡</button>
                <button class="btn" onclick="downloadExcel()" style="background:#10b981;color:#fff">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>

        <!-- ë‚ ì§œ ë²”ìœ„ í•„í„° -->
        <div class="date-range-bar" style="margin-bottom:14px">
            <div>
                <label style="font-weight:600;color:#333;margin-right:4px">ğŸ“… ê¸°ê°„:</label>
                <button class="btn btn-outline active" onclick="setDateRange('all')" id="dateRange-all">ì „ì²´</button>
                <button class="btn btn-outline" onclick="setDateRange('today')" id="dateRange-today">ì˜¤ëŠ˜</button>
                <button class="btn btn-outline" onclick="setDateRange('week')" id="dateRange-week">ì´ë²ˆ ì£¼</button>
                <button class="btn btn-outline" onclick="setDateRange('month')" id="dateRange-month">ì´ë²ˆ ë‹¬</button>
                <div style="border-left:2px solid #ddd;height:28px;margin:0 4px"></div>
                <input type="date" id="customStartDate" style="padding:7px;border:1px solid #ddd;border-radius:6px;font-size:13px">
                <span style="color:#999">~</span>
                <input type="date" id="customEndDate" style="padding:7px;border:1px solid #ddd;border-radius:6px;font-size:13px">
                <button class="btn btn-primary" onclick="setDateRange('custom')" style="font-size:13px;padding:8px 14px">ì ìš©</button>
            </div>
            <div id="dateRangeDisplay" style="margin-top:8px;color:#2196F3;font-size:13px;font-weight:500"></div>
        </div>

        <!-- ìƒíƒœ í•„í„° -->
        <div class="filter-section">
            <button class="btn btn-outline active" onclick="filterSchedules('all',event)">ì „ì²´</button>
            <button class="btn btn-outline" onclick="filterSchedules('unconfirmed',event)">ë¯¸í™•ì¸ë§Œ</button>
            <button class="btn btn-outline" onclick="filterSchedules('confirmed',event)">í™•ì¸ ì™„ë£Œë§Œ</button>
            <button class="btn btn-outline" onclick="filterSchedules('completed',event)">ì°¸ì„ ì™„ë£Œë§Œ</button>
        </div>

        <!-- ì†ê¸°ì‚¬ ì„ íƒ -->
        <div style="margin:16px 0">
            <label style="font-weight:500;color:#666;margin-right:8px">ì†ê¸°ì‚¬ ì„ íƒ:</label>
            <select id="adminFreelancerSelect" onchange="filterByFreelancer()" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                <option value="">ì „ì²´ ë³´ê¸°</option>
            </select>
        </div>

        <!-- ì†ê¸°ì‚¬ ìš”ì•½ -->
        <div id="freelancerSummary">
            <div style="font-weight:700;color:#2196F3;margin-bottom:10px;font-size:16px" id="summaryTitle"></div>
            <div style="display:flex;gap:20px;flex-wrap:wrap">
                <div><span style="color:#666;font-size:14px">ì´ë²ˆ ë‹¬ ì¶œì¥:</span><span style="font-weight:700;color:#333;font-size:18px;margin:0 4px" id="summaryTotal">0</span><span style="color:#666;font-size:14px">ê±´</span></div>
                <div style="flex:1;min-width:200px"><div style="color:#666;font-size:14px;margin-bottom:4px">ë°©ë¬¸ êµìœ¡ì§€ì›ì²­:</div><div id="summaryMeetings" style="color:#333;font-size:13px;line-height:1.6"></div></div>
            </div>
        </div>

        <!-- ì˜¤ëŠ˜ ì¼ì • -->
        <div id="todaySchedules">
            <div style="font-weight:700;color:#333;font-size:16px;display:flex;align-items:center;gap:8px">
                <span>ğŸ“… ì˜¤ëŠ˜ì˜ ì¼ì •</span>
                <span id="todayDate" style="color:#666;font-size:14px;font-weight:400"></span>
            </div>
            <div id="todayScheduleList"></div>
        </div>

        <!-- ìº˜ë¦°ë” -->
        <div class="calendar">
            <div class="calendar-header">
                <button class="btn btn-outline" onclick="changeMonth(-1)">â—€ ì´ì „</button>
                <div class="calendar-month" id="currentMonth"></div>
                <button class="btn btn-outline" onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="schedule-list" id="adminScheduleList"></div>
    </div>

    <!-- í”„ë¦¬ëœì„œ í™”ë©´ -->
    <div id="freelancerView" style="display:none">
        <div class="calendar">
            <div class="calendar-header">
                <button class="btn btn-outline" onclick="changeMonth(-1)">â—€ ì´ì „</button>
                <div class="calendar-month" id="freelancerCurrentMonth"></div>
                <button class="btn btn-outline" onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button>
            </div>
            <div class="calendar-grid" id="freelancerCalendarGrid"></div>
        </div>
        <div class="schedule-list freelancer-view" id="freelancerScheduleList"></div>
    </div>

    <!-- íšŒì› ê´€ë¦¬ í™”ë©´ -->
    <div id="usersView" style="display:none">
        <div style="margin-bottom:28px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                <h2 style="font-size:18px;color:#333">ê°€ì… ëŒ€ê¸° ì¤‘ (<span id="pendingCount">0</span>ëª…)</h2>
            </div>
            <div id="pendingUsersList"></div>
        </div>
        <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                <h2 style="font-size:18px;color:#333">ìŠ¹ì¸ëœ ì†ê¸°ì‚¬ (<span id="approvedCount">0</span>ëª…)</h2>
            </div>
            <div id="approvedUsersList"></div>
        </div>
    </div>

    <!-- ìŠˆí¼ê´€ë¦¬ì: ê´€ë¦¬ì ê´€ë¦¬ í™”ë©´ -->
    <div id="adminsView" style="display:none">
        <div style="margin-bottom:28px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                <h2 style="font-size:18px;color:#333">ê´€ë¦¬ì ê³„ì • (<span id="adminCount">0</span>ëª…)</h2>
                <button class="btn btn-purple" onclick="openAddAdminModal()">+ ê´€ë¦¬ì ì¶”ê°€</button>
            </div>
            <div id="adminUsersList"></div>
        </div>
    </div>
</div>

<!-- ========== ëª¨ë‹¬ë“¤ ========== -->

<!-- ì¼ì • ë“±ë¡ ëª¨ë‹¬ -->
<div class="modal" id="addScheduleModal">
    <div class="modal-content wide">
        <div class="modal-header">ìƒˆ ì¼ì • ë“±ë¡ <button class="modal-close" onclick="closeAddScheduleModal()">Ã—</button></div>
        <form onsubmit="addSchedule(event)">
            <div class="form-group" style="margin-bottom:16px">
                <label>ì†ê¸°ì‚¬ ì„ íƒ</label>
                <select id="scheduleFreelancer" required onchange="updateFreelancerSuggestions()">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom:16px">
                <label>íšŒì˜ëª… (êµìœ¡ì§€ì›ì²­ëª…)</label>
                <input type="text" id="scheduleTitle" required placeholder="ì˜ˆ: ì²œì•ˆêµìœ¡ì§€ì›ì²­" list="meetingList">
                <datalist id="meetingList"></datalist>
            </div>
            <div class="form-group" style="margin-bottom:16px">
                <label>ë‚ ì§œ ì„ íƒ (ì—¬ëŸ¬ ë‚ ì§œ ë™ì‹œ ì„ íƒ ê°€ëŠ¥)</label>
                <div style="background:#f9f9f9;border:1px solid #ddd;border-radius:6px;padding:14px;margin-top:6px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <button type="button" class="btn btn-outline" onclick="changeBulkMonth(-1)" style="padding:5px 10px">â—€</button>
                        <div id="bulkMonthDisplay" style="font-weight:700"></div>
                        <button type="button" class="btn btn-outline" onclick="changeBulkMonth(1)" style="padding:5px 10px">â–¶</button>
                    </div>
                    <div id="bulkDateSelector"></div>
                </div>
                <div style="margin-top:8px;color:#666;font-size:13px">ì„ íƒëœ ë‚ ì§œ: <span id="selectedDatesDisplay" style="color:#4CAF50;font-weight:700">ì—†ìŒ</span></div>
            </div>
            <div class="form-group" id="timeSettingsContainer" style="display:none;margin-bottom:16px">
                <label>ë‚ ì§œë³„ ì‹œê°„ ì„¤ì •</label>
                <div id="timeSettingsList" style="background:#f9f9f9;border:1px solid #ddd;border-radius:6px;padding:14px;max-height:280px;overflow-y:auto;margin-top:6px"></div>
            </div>
            <div class="form-group" style="margin-bottom:20px">
                <label>ë©”ëª¨</label>
                <textarea id="scheduleMemo" placeholder="ì¶”ê°€ ì•ˆë‚´ì‚¬í•­"></textarea>
            </div>
            <div style="display:flex;gap:10px">
                <button type="submit" class="btn btn-primary" style="flex:1">ë“±ë¡</button>
                <button type="button" class="btn btn-outline" style="flex:1" onclick="closeAddScheduleModal()">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<!-- ë‚ ì§œ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal" id="dateDetailModal">
    <div class="modal-content wide">
        <div class="modal-header"><div id="dateDetailTitle"></div><button class="modal-close" onclick="closeDateDetailModal()">Ã—</button></div>
        <div id="dateDetailContent" style="max-height:480px;overflow-y:auto"></div>
        <div style="margin-top:18px;text-align:right"><button class="btn btn-outline" onclick="closeDateDetailModal()">ë‹«ê¸°</button></div>
    </div>
</div>

<!-- ì¼ì • ìˆ˜ì • ëª¨ë‹¬ (í•˜ë‚˜ë§Œ) -->
<div class="modal" id="editScheduleModal">
    <div class="modal-content">
        <div class="modal-header">ì¼ì • ìˆ˜ì • <button class="modal-close" onclick="closeEditScheduleModal()">Ã—</button></div>
        <form onsubmit="saveScheduleEdit(event)">
            <input type="hidden" id="editScheduleId">
            <div class="form-group" style="margin-bottom:14px">
                <label>ì†ê¸°ì‚¬ ì„ íƒ</label>
                <select id="editScheduleFreelancer" required><option value="">ì„ íƒí•˜ì„¸ìš”</option></select>
            </div>
            <div class="form-group" style="margin-bottom:14px">
                <label>íšŒì˜ëª…</label>
                <input type="text" id="editScheduleTitle" required placeholder="íšŒì˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group" style="margin-bottom:14px">
                <label>ë‚ ì§œ</label>
                <input type="date" id="editScheduleDate" required>
            </div>
            <div class="form-group" style="margin-bottom:14px">
                <label>ì‹œê°„</label>
                <select id="editScheduleTime" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
                    <option value="">ì‹œê°„ ì„ íƒ</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom:20px">
                <label>ë©”ëª¨</label>
                <textarea id="editScheduleMemo" placeholder="ì¶”ê°€ ì•ˆë‚´ì‚¬í•­"></textarea>
            </div>
            <div style="display:flex;gap:10px">
                <button type="submit" class="btn btn-primary" style="flex:1">ìˆ˜ì • ì™„ë£Œ</button>
                <button type="button" class="btn btn-outline" style="flex:1" onclick="closeEditScheduleModal()">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<!-- ì‹œê°„ ê¸°ë¡ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal" id="editTimeLogModal">
    <div class="modal-content">
        <div class="modal-header">íšŒì˜ ì‹œê°„ ìˆ˜ì • <button class="modal-close" onclick="closeEditTimeLogModal()">Ã—</button></div>
        <form onsubmit="saveTimeLogEdit(event)">
            <input type="hidden" id="editTimeLogScheduleId">
            <div class="form-group" style="margin-bottom:14px">
                <label>ì‹œì‘ ì‹œê°„</label>
                <div style="display:flex;gap:8px;align-items:center">
                    <input type="number" id="editStartHour" min="0" max="23" required style="width:70px;text-align:center" placeholder="00">
                    <span>ì‹œ</span>
                    <input type="number" id="editStartMinute" min="0" max="59" required style="width:70px;text-align:center" placeholder="00">
                    <span>ë¶„</span>
                </div>
            </div>
            <div class="form-group" style="margin-bottom:14px">
                <label>ì¢…ë£Œ ì‹œê°„</label>
                <div style="display:flex;gap:8px;align-items:center">
                    <input type="number" id="editEndHour" min="0" max="23" required style="width:70px;text-align:center" placeholder="00">
                    <span>ì‹œ</span>
                    <input type="number" id="editEndMinute" min="0" max="59" required style="width:70px;text-align:center" placeholder="00">
                    <span>ë¶„</span>
                </div>
            </div>
            <div class="form-group" style="margin-bottom:20px">
                <label>ì •íšŒ ì‹œê°„ (ë¶„)</label>
                <div style="display:flex;gap:8px;align-items:center">
                    <input type="number" id="editBreakMinutes" min="0" value="0" style="width:80px;text-align:center">
                    <span>ë¶„</span>
                </div>
                <div style="font-size:12px;color:#999;margin-top:4px">ì˜ˆ: 30ë¶„ ì •íšŒí–ˆìœ¼ë©´ 30 ì…ë ¥</div>
            </div>
            <div style="display:flex;gap:10px">
                <button type="submit" class="btn btn-primary" style="flex:1">ì €ì¥</button>
                <button type="button" class="btn btn-outline" style="flex:1" onclick="closeEditTimeLogModal()">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<!-- ê´€ë¦¬ì ì¶”ê°€ ëª¨ë‹¬ (ìŠˆí¼ê´€ë¦¬ì ì „ìš©) -->
<div class="modal" id="addAdminModal">
    <div class="modal-content">
        <div class="modal-header">ê´€ë¦¬ì ì¶”ê°€ <button class="modal-close" onclick="closeAddAdminModal()">Ã—</button></div>
        <p style="color:#666;font-size:14px;margin-bottom:20px">ìŠ¹ì¸ëœ ì†ê¸°ì‚¬ë¥¼ ê´€ë¦¬ìë¡œ ìŠ¹ê²©í•˜ê±°ë‚˜, ìƒˆ ê´€ë¦¬ì ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
        <div class="form-group" style="margin-bottom:14px">
            <label>ì†ê¸°ì‚¬ ì„ íƒ (ìŠ¹ê²©)</label>
            <select id="promoteFreelancerSelect" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            </select>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px">
            <button class="btn btn-purple" style="flex:1" onclick="promoteToAdmin()">ê´€ë¦¬ìë¡œ ìŠ¹ê²©</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAddAdminModal()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
// ========================
// â‘  CONFIG (ì—¬ê¸°ì— ì‹¤ì œ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”)
// ========================
const SUPABASE_URL      = 'https://qpmigmvpbiojrevuftxw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwbWlnbXZwYmlvanJldnVmdHh3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDY1NDEsImV4cCI6MjA4NzY4MjU0MX0.2waRZj9kDSumx7w7PGijHVl1gz5O__WzP-xaD8F0YdA';
const ONESIGNAL_APP_ID  = '60d56969-f312-4568-8918-45f0555dce1f';   // OneSignal > Settings > Keys & IDs
const APP_EMAIL_DOMAIN  = 'skillnote.app';            // ë‚´ë¶€ ì´ë©”ì¼ ë„ë©”ì¸ (ë³€ê²½ ê°€ëŠ¥)

// ========================
// â‘¡ SUPABASE ì´ˆê¸°í™”
// ========================
const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ========================
// â‘¢ ì „ì—­ ìƒíƒœ
// ========================
let schedules        = [];   // Supabaseì—ì„œ ë¡œë“œí•œ ì¼ì • ìºì‹œ
let freelancerProfiles = []; // ìŠ¹ì¸ëœ í”„ë¦¬ëœì„œ ëª©ë¡
let allProfiles      = [];   // ì „ì²´ í”„ë¡œí•„ (ê´€ë¦¬ììš©)
let pendingProfiles  = [];   // ë¯¸ìŠ¹ì¸ í”„ë¦¬ëœì„œ
let currentUser      = null;
let currentDate      = new Date();
let currentView      = 'admin';
let currentFilter    = 'all';
let selectedFreelancer = '';
let searchQuery      = '';
let dateRangeFilter  = { type: 'all', startDate: null, endDate: null };
let bulkDate         = new Date();
let selectedDates    = [];
let dateTimePairs    = {};
let ongoingMeetings  = {};
let meetingTitlesHistory = []; // íšŒì˜ëª… ìë™ì™„ì„±

// ========================
// â‘£ ì´ˆê¸°í™”
// ========================
document.addEventListener('DOMContentLoaded', initApp);

async function initApp() {
    showLoading(true);
    try {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            await loadSessionUser(session.user.id);
        } else {
            showLoginScreen();
        }
    } catch (e) {
        console.error('initApp error:', e);
        showLoginScreen();
    } finally {
        showLoading(false);
    }
    // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ë¸Œë¼ìš°ì € ë ˆë²¨)
    if ('Notification' in window && Notification.permission === 'default') {
        setTimeout(() => Notification.requestPermission(), 3000);
    }
}

async function loadSessionUser(userId) {
    const { data: profile, error } = await sb
        .from('profiles').select('*').eq('id', userId).single();
    if (!profile || error) { await sb.auth.signOut(); showLoginScreen(); return; }
    if (profile.role === 'freelancer' && !profile.approved) {
        await sb.auth.signOut();
        showLoginScreen();
        showFieldError('loginError', 'ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ìŠ¹ì¸ í›„ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        return;
    }
    currentUser = profile;
    await loadAllData();
    setupRealtime();
    initOneSignal();
    showMainScreen();
}

// ========================
// â‘¤ ì¸ì¦ í•¨ìˆ˜
// ========================
async function handleLogin(event) {
    event.preventDefault();
    const name = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!name) return;
    const email = `${encodeURIComponent(name)}@${APP_EMAIL_DOMAIN}`;
    showLoading(true);
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    showLoading(false);
    if (error) {
        showFieldError('loginError', error.message || 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    await loadSessionUser(data.user.id);
}

async function handleSignup(event) {
    event.preventDefault();
    const name     = document.getElementById('signupName').value.trim();
    const phone    = document.getElementById('signupPhone').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirm  = document.getElementById('signupPasswordConfirm').value;
    if (password !== confirm) { showFieldError('signupError', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
    if (password.length < 6)  { showFieldError('signupError', 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }

    showLoading(true);
    const email = `${encodeURIComponent(name)}@${APP_EMAIL_DOMAIN}`;
    const { data, error } = await sb.auth.signUp({
        email, password,
        options: { data: { name, phone, role: 'freelancer', approved: false } }
    });
    showLoading(false);

    if (error) {
        const msg = error.message.includes('already') ? 'ì´ë¯¸ ê°€ì…ëœ ì´ë¦„ì…ë‹ˆë‹¤.' : 'ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        showFieldError('signupError', msg); return;
    }
    // í”„ë¡œí•„ì´ íŠ¸ë¦¬ê±°ë¡œ ìë™ ìƒì„±ë˜ì§€ë§Œ phoneì€ ìˆ˜ë™ ì—…ë°ì´íŠ¸ í•„ìš”
    if (data?.user) {
        await sb.from('profiles').update({ phone }).eq('id', data.user.id);
    }
    document.getElementById('signupScreen').style.display = 'none';
    document.getElementById('signupSuccessScreen').style.display = 'block';
}

async function handleLogout() {
    if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await sb.auth.signOut();
    schedules = []; freelancerProfiles = []; allProfiles = []; pendingProfiles = [];
    currentUser = null; searchQuery = '';
    showLoginScreen();
}

// ========================
// â‘¥ ë°ì´í„° ë¡œë“œ (Supabase â†’ ë¡œì»¬ ìºì‹œ)
// ========================
async function loadAllData() {
    await Promise.all([loadSchedules(), loadProfiles()]);
}

async function loadSchedules() {
    let query = sb.from('schedules').select('*').order('date').order('time');
    if (currentUser.role === 'freelancer') {
        query = query.eq('freelancer_id', currentUser.id);
    }
    const { data } = await query;
    if (data) schedules = data;
}

async function loadProfiles() {
    if (currentUser.role === 'freelancer') return;
    const { data } = await sb.from('profiles').select('*').order('name');
    if (!data) return;
    allProfiles      = data;
    freelancerProfiles = data.filter(p => p.role === 'freelancer' && p.approved);
    pendingProfiles    = data.filter(p => p.role === 'freelancer' && !p.approved);
    // íšŒì˜ëª… ìë™ì™„ì„± ëª©ë¡ ì¶”ì¶œ
    meetingTitlesHistory = [...new Set(schedules.map(s => s.title))].sort();
}

// ========================
// â‘¦ Supabase Realtime (ì‹¤ì‹œê°„ ë™ê¸°í™” + ë¸Œë¼ìš°ì € ì•Œë¦¼)
// ========================
function setupRealtime() {
    const filter = currentUser.role === 'freelancer'
        ? { filter: `freelancer_id=eq.${currentUser.id}` } : {};

    sb.channel('schedules-realtime')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'schedules', ...filter }, payload => {
            const s = payload.new;
            if (!schedules.find(x => x.id === s.id)) schedules.push(s);
            if (currentUser.role === 'freelancer') {
                showBrowserNotification('ğŸ“… ìƒˆ ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', `${s.title} (${s.date} ${s.time})`);
            }
            refreshAdminViews();
        })
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'schedules', ...filter }, payload => {
            const idx = schedules.findIndex(x => x.id === payload.new.id);
            if (idx >= 0) schedules[idx] = payload.new;
            if (currentUser.role === 'freelancer' && payload.new.freelancer_id === currentUser.id) {
                showBrowserNotification('âœï¸ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', `${payload.new.title} (${payload.new.date})`);
            }
            refreshAdminViews();
        })
        .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'schedules', ...filter }, payload => {
            schedules = schedules.filter(x => x.id !== payload.old.id);
            refreshAdminViews();
        })
        .subscribe();
}

function refreshAdminViews() {
    if (currentView === 'admin') {
        renderTodaySchedules(); renderCalendar(); renderScheduleList(); updateStats();
    } else if (currentView === 'freelancer') {
        loadFreelancerSchedules();
    }
}

function showBrowserNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body, icon: 'https://via.placeholder.com/64/2196F3/ffffff?text=%EC%9D%BC' });
    }
}

// ========================
// â‘§ OneSignal í‘¸ì‹œ ì´ˆê¸°í™”
// ========================
function initOneSignal() {
    if (!ONESIGNAL_APP_ID || ONESIGNAL_APP_ID === 'YOUR_ONESIGNAL_APP_ID') return;
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({ appId: ONESIGNAL_APP_ID, notifyButton: { enable: false }, allowLocalhostAsSecureOrigin: true });
        const userId = await OneSignal.User.PushSubscription.id;
        if (userId && currentUser) {
            await sb.from('profiles').update({ onesignal_player_id: userId }).eq('id', currentUser.id);
        }
    });
}

async function sendPushNotification(freelancerId, message, title = 'ì†ê¸°ì‚¬ ì¼ì • ê´€ë¦¬') {
    if (!ONESIGNAL_APP_ID || ONESIGNAL_APP_ID === 'YOUR_ONESIGNAL_APP_ID') return;
    try {
        await sb.functions.invoke('send-push', { body: { freelancer_id: freelancerId, message, title } });
    } catch (e) { console.log('Push failed (non-blocking):', e); }
}

// ========================
// â‘¨ í™”ë©´ ì „í™˜
// ========================
function showLoginScreen() {
    hide('mainScreen'); hide('signupScreen'); hide('signupSuccessScreen');
    show('loginScreen');
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    clearFieldError('loginError');
}
function showSignupScreen() {
    hide('loginScreen'); show('signupScreen');
    clearFieldError('signupError');
}

function showMainScreen() {
    hide('loginScreen');
    show('mainScreen');
    const isSA = currentUser.role === 'superadmin';
    const isAdmin = currentUser.role === 'admin' || isSA;
    const badge = isSA ? '<span class="superadmin-badge">ìŠˆí¼ê´€ë¦¬ì</span>'
                : isAdmin ? '<span class="admin-badge">ê´€ë¦¬ì</span>' : '';
    document.getElementById('welcomeMessage').innerHTML = `${currentUser.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤${badge}`;
    document.getElementById('viewToggle').style.display = isAdmin ? 'flex' : 'none';
    if (isSA) show('adminMgmtTab');
    if (isAdmin) {
        switchViewInternal('admin');
    } else {
        switchViewInternal('freelancer');
    }
}

function switchView(view) {
    switchViewInternal(view);
    document.querySelectorAll('.user-toggle .btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
}

function switchViewInternal(view) {
    currentView = view;
    hide('adminView'); hide('freelancerView'); hide('usersView'); hide('adminsView');
    const titles = { admin:'ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ', freelancer:'ë‚´ ì¼ì •', users:'íšŒì› ê´€ë¦¬', admins:'ê´€ë¦¬ì ê´€ë¦¬' };
    document.getElementById('pageTitle').textContent = titles[view] || '';
    if (view === 'admin') {
        show('adminView');
        loadFreelancerOptions();
        renderTodaySchedules(); renderCalendar(); renderScheduleList(); updateStats();
    } else if (view === 'freelancer') {
        show('freelancerView');
        loadFreelancerSchedules();
    } else if (view === 'users') {
        show('usersView');
        renderPendingUsers(); renderApprovedUsers();
    } else if (view === 'admins') {
        show('adminsView');
        renderAdminUsers();
    }
}

// ========================
// â‘© ê²€ìƒ‰
// ========================
function handleSearch(q) {
    searchQuery = q.trim().toLowerCase();
    renderScheduleList();
    renderCalendar();
}
function clearSearch() {
    document.getElementById('searchInput').value = '';
    searchQuery = '';
    renderScheduleList(); renderCalendar();
}
function applySearchFilter(arr) {
    if (!searchQuery) return arr;
    return arr.filter(s =>
        s.title.toLowerCase().includes(searchQuery) ||
        s.freelancer_name.toLowerCase().includes(searchQuery)
    );
}

// ========================
// â‘ª í•„í„°
// ========================
function filterSchedules(filter, ev) {
    currentFilter = filter;
    document.querySelectorAll('.filter-section .btn').forEach(b => b.classList.remove('active'));
    if (ev && ev.target) ev.target.classList.add('active');
    renderScheduleList();
}

function filterByFreelancer() {
    selectedFreelancer = document.getElementById('adminFreelancerSelect').value;
    updateFreelancerSummary();
    renderTodaySchedules(); renderCalendar(); renderScheduleList();
}

function setDateRange(type) {
    const today = new Date(); today.setHours(0,0,0,0);
    document.querySelectorAll('[id^="dateRange-"]').forEach(b => b.classList.remove('active'));
    if (type === 'all') {
        dateRangeFilter = { type:'all', startDate:null, endDate:null };
        el('dateRange-all').classList.add('active');
        el('dateRangeDisplay').textContent = '';
    } else if (type === 'today') {
        const d = today.toISOString().split('T')[0];
        dateRangeFilter = { type:'today', startDate:d, endDate:d };
        el('dateRange-today').classList.add('active');
        el('dateRangeDisplay').textContent = `ì˜¤ëŠ˜ (${today.getMonth()+1}ì›” ${today.getDate()}ì¼)`;
    } else if (type === 'week') {
        const dow = today.getDay(), diff = dow===0 ? -6 : 1-dow;
        const mon = new Date(today); mon.setDate(today.getDate()+diff);
        const sun = new Date(mon); sun.setDate(mon.getDate()+6);
        dateRangeFilter = { type:'week', startDate:mon.toISOString().split('T')[0], endDate:sun.toISOString().split('T')[0] };
        el('dateRange-week').classList.add('active');
        el('dateRangeDisplay').textContent = `ì´ë²ˆ ì£¼ (${mon.getMonth()+1}/${mon.getDate()} ~ ${sun.getMonth()+1}/${sun.getDate()})`;
    } else if (type === 'month') {
        const first = new Date(today.getFullYear(), today.getMonth(), 1);
        const last  = new Date(today.getFullYear(), today.getMonth()+1, 0);
        dateRangeFilter = { type:'month', startDate:first.toISOString().split('T')[0], endDate:last.toISOString().split('T')[0] };
        el('dateRange-month').classList.add('active');
        el('dateRangeDisplay').textContent = `ì´ë²ˆ ë‹¬ (${today.getMonth()+1}ì›” 1ì¼ ~ ${last.getDate()}ì¼)`;
    } else if (type === 'custom') {
        const s = el('customStartDate').value, e = el('customEndDate').value;
        if (!s || !e) { alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
        if (s > e)    { alert('ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¦…ë‹ˆë‹¤.'); return; }
        dateRangeFilter = { type:'custom', startDate:s, endDate:e };
        const sd = new Date(s), ed = new Date(e);
        el('dateRangeDisplay').textContent = `ì‚¬ìš©ì ì§€ì • (${sd.getMonth()+1}/${sd.getDate()} ~ ${ed.getMonth()+1}/${ed.getDate()})`;
    }
    renderScheduleList();
}

function getFilteredSchedules() {
    let arr = [...schedules];
    if (dateRangeFilter.type !== 'all') {
        arr = arr.filter(s => s.date >= dateRangeFilter.startDate && s.date <= dateRangeFilter.endDate);
    }
    if (selectedFreelancer) arr = arr.filter(s => s.freelancer_id === selectedFreelancer);
    if (currentFilter !== 'all') arr = arr.filter(s => s.status === currentFilter);
    return applySearchFilter(arr);
}

// ========================
// â‘« í†µê³„
// ========================
function updateStats() {
    const arr = getFilteredSchedules();
    el('totalSchedules').textContent   = arr.length;
    el('unconfirmedCount').textContent = arr.filter(s => s.status==='unconfirmed').length;
    el('confirmedCount').textContent   = arr.filter(s => s.status==='confirmed').length;
    el('completedCount').textContent   = arr.filter(s => s.status==='completed').length;
}

// ========================
// â‘¬ ì†ê¸°ì‚¬ ìš”ì•½
// ========================
function updateFreelancerSummary() {
    const div = el('freelancerSummary');
    if (!selectedFreelancer) { div.style.display='none'; return; }
    div.style.display = 'block';
    const year = currentDate.getFullYear(), month = currentDate.getMonth();
    const first = `${year}-${pad(month+1)}-01`;
    const last  = `${year}-${pad(month+1)}-${pad(new Date(year,month+1,0).getDate())}`;
    const fl = schedules.filter(s => s.freelancer_id===selectedFreelancer && s.date>=first && s.date<=last);
    const profile = freelancerProfiles.find(p => p.id===selectedFreelancer);
    el('summaryTitle').textContent = `${profile?.name||''} ì†ê¸°ì‚¬`;
    el('summaryTotal').textContent = fl.length;
    const meetings = [...new Set(fl.map(s=>s.title))];
    el('summaryMeetings').textContent = meetings.map(m=>`${m}(${fl.filter(s=>s.title===m).length}ê±´)`).join(', ') || 'ì¼ì • ì—†ìŒ';
}

// ========================
// â‘­ ì˜¤ëŠ˜ ì¼ì •
// ========================
function renderTodaySchedules() {
    const today = new Date(), todayStr = today.toISOString().split('T')[0];
    const mn = today.getMonth()+1, dy = today.getDate(), dn = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][today.getDay()];
    el('todayDate').textContent = `(${mn}ì›” ${dy}ì¼ ${dn}ìš”ì¼)`;
    let arr = schedules.filter(s => s.date===todayStr);
    if (selectedFreelancer) arr = arr.filter(s => s.freelancer_id===selectedFreelancer);
    arr = applySearchFilter(arr);
    const listEl = el('todayScheduleList');
    listEl.innerHTML = '';
    if (arr.length===0) { listEl.innerHTML='<div style="color:#999;font-size:14px;padding:6px 0">ì˜¤ëŠ˜ ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    const cfg = { unconfirmed:{color:'#ff5252',icon:'ğŸ”´',text:'ë¯¸í™•ì¸'}, confirmed:{color:'#4caf50',icon:'ğŸŸ¢',text:'í™•ì¸ì™„ë£Œ'}, completed:{color:'#2196f3',icon:'ğŸ”µ',text:'ì°¸ì„ì™„ë£Œ'} };
    arr.forEach(s => {
        const c = cfg[s.status];
        const d = document.createElement('div');
        d.className = 'today-card';
        d.style.borderLeft = `4px solid ${c.color}`;
        d.innerHTML = `<span>${c.icon}</span><div style="flex:1"><div style="font-weight:700;font-size:14px;color:#333">${s.freelancer_name} - ${s.title}</div><div style="color:#666;font-size:13px">${s.time}</div></div><div style="font-size:11px;color:${c.color};font-weight:600">${c.text}</div>`;
        listEl.appendChild(d);
    });
}

// ========================
// â‘® ìº˜ë¦°ë”
// ========================
function renderCalendar() {
    const year = currentDate.getFullYear(), month = currentDate.getMonth();
    const isAdmin = currentView === 'admin';
    const monthEl = el(isAdmin ? 'currentMonth' : 'freelancerCurrentMonth');
    const gridEl  = el(isAdmin ? 'calendarGrid'  : 'freelancerCalendarGrid');
    if (!monthEl || !gridEl) return;
    monthEl.textContent = `${year}ë…„ ${month+1}ì›”`;
    gridEl.innerHTML = '';
    ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => {
        const h = document.createElement('div'); h.className='calendar-day-header'; h.textContent=d; gridEl.appendChild(h);
    });
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month+1, 0).getDate();
    const todayStr = new Date().toISOString().split('T')[0];
    for (let i=0; i<firstDay; i++) gridEl.appendChild(document.createElement('div'));
    for (let date=1; date<=lastDate; date++) {
        const dateStr = `${year}-${pad(month+1)}-${pad(date)}`;
        let daySchedules = schedules.filter(s => s.date===dateStr);
        if (isAdmin && selectedFreelancer) daySchedules = daySchedules.filter(s => s.freelancer_id===selectedFreelancer);
        if (!isAdmin && currentUser.role==='freelancer') daySchedules = daySchedules.filter(s => s.freelancer_id===currentUser.id);
        daySchedules = applySearchFilter(daySchedules);
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day' + (daySchedules.length ? ' has-event' : '') + (dateStr===todayStr ? ' today' : '');
        dayEl.innerHTML = `<div class="day-number${dateStr===todayStr?' today-num':''}">${date}</div>`;
        if (daySchedules.length) {
            const prev = document.createElement('div'); prev.className='event-preview';
            prev.innerHTML = daySchedules.slice(0,3).map(s=>`<span class="event-dot"></span>${s.freelancer_name.slice(0,2)}-${s.title.replace('êµìœ¡ì§€ì›ì²­','')}`).join('<br>');
            if (daySchedules.length>3) { const m=document.createElement('div'); m.style.cssText='color:#2196F3;font-weight:700;font-size:9px'; m.textContent=`+${daySchedules.length-3}ê±´`; prev.appendChild(m); }
            dayEl.appendChild(prev);
        }
        if (daySchedules.length || isAdmin) {
            dayEl.style.cursor='pointer';
            dayEl.onclick = () => showDateDetail(dateStr, daySchedules);
        }
        gridEl.appendChild(dayEl);
    }
}

function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth()+delta);
    if (selectedFreelancer) updateFreelancerSummary();
    renderCalendar();
}

// ========================
// â‘¯ ë‚ ì§œ ìƒì„¸
// ========================
function showDateDetail(dateStr, daySchedules) {
    const d = new Date(dateStr+'T00:00:00'), mn=d.getMonth()+1, dy=d.getDate(), dn=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
    el('dateDetailTitle').textContent = `${mn}ì›” ${dy}ì¼ (${dn}) - ì´ ${daySchedules.length}ê±´`;
    const contentEl = el('dateDetailContent'); contentEl.innerHTML='';
    if (!daySchedules.length) { contentEl.innerHTML='<div style="padding:40px;text-align:center;color:#999">ì´ ë‚ ì§œì— ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; }
    else {
        daySchedules.sort((a,b)=>a.time.localeCompare(b.time));
        const stCfg = { unconfirmed:{color:'#ff5252',icon:'ğŸ”´',text:'ë¯¸í™•ì¸'}, confirmed:{color:'#ff9800',icon:'ğŸŸ¡',text:'í™•ì¸ì™„ë£Œ'}, completed:{color:'#4caf50',icon:'ğŸŸ¢',text:'ì°¸ì„ì™„ë£Œ'} };
        daySchedules.forEach(s => {
            const st = stCfg[s.status];
            const card = document.createElement('div');
            card.style.cssText='background:#f9f9f9;border-left:4px solid #2196F3;padding:14px;margin-bottom:10px;border-radius:6px';
            let timeLogHTML='';
            if (s.time_log?.endTime) {
                const wm=s.time_log.totalWorkMinutes||0;
                timeLogHTML=`<div style="background:#e8f5e9;border-radius:6px;padding:10px;margin-top:10px"><div style="font-weight:700;color:#2e7d32;margin-bottom:4px">â±ï¸ ì‹¤ì œ ê·¼ë¬´ì‹œê°„</div><div style="font-size:12px;color:#555">${s.time_log.startTime} ~ ${s.time_log.endTime}<br><strong style="color:#1976d2">ì´ ${Math.floor(wm/60)}ì‹œê°„ ${wm%60}ë¶„</strong></div></div>`;
            }
            card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px"><div style="flex:1"><div style="font-weight:700;color:#333;font-size:16px;margin-bottom:4px">${s.title}</div><div style="color:#666;font-size:14px;display:flex;gap:12px"><span>â° ${s.time}</span><span>ğŸ‘¤ ${s.freelancer_name}</span></div></div><span style="background:${st.color}20;color:${st.color};padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;white-space:nowrap">${st.icon} ${st.text}</span></div>${s.memo?`<div style="color:#666;font-size:13px;padding-top:8px;border-top:1px solid #e0e0e0">ğŸ“ ${s.memo}</div>`:''}${timeLogHTML}${currentView==='admin'?`<div style="display:flex;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid #e0e0e0"><button class="btn btn-outline" onclick="closeDateDetailModal();openEditScheduleModal(${s.id})" style="flex:1;font-size:12px;padding:6px">âœï¸ ìˆ˜ì •</button><button class="btn" onclick="deleteSchedule(${s.id})" style="flex:1;font-size:12px;padding:6px;background:#ffebee;color:#c62828;border:1px solid #ffcdd2">ğŸ—‘ï¸ ì‚­ì œ</button></div>`:''}`;
            contentEl.appendChild(card);
        });
    }
    el('dateDetailModal').classList.add('show');
}
function closeDateDetailModal() { el('dateDetailModal').classList.remove('show'); }

// ========================
// â‘° ì¼ì • ëª©ë¡ ë Œë”ë§
// ========================
function renderScheduleList() {
    const listEl = el('adminScheduleList'); listEl.innerHTML='';
    const filtered = getFilteredSchedules();
    filtered.sort((a,b)=>a.date.localeCompare(b.date)||a.time.localeCompare(b.time));
    const byDate={};
    filtered.forEach(s=>{ if(!byDate[s.date]) byDate[s.date]=[]; byDate[s.date].push(s); });
    const dates = Object.keys(byDate).sort();
    if (!dates.length) { listEl.innerHTML='<div style="padding:40px;text-align:center;color:#999">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; updateStats(); return; }
    dates.forEach((dateStr, idx) => {
        const d=new Date(dateStr+'T00:00:00'), mn=d.getMonth()+1, dy=d.getDate(), dn=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
        const daySchedules=byDate[dateStr];
        const accordionId=`acc-${dateStr}`;
        const isExp = idx===0;
        const wrap = document.createElement('div'); wrap.style.marginBottom='10px';
        const hdr = document.createElement('div');
        hdr.style.cssText='background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:13px 16px;border-radius:8px;font-weight:700;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none';
        hdr.innerHTML=`<div style="display:flex;align-items:center;gap:10px"><span id="arr-${accordionId}">${isExp?'â–¼':'â–¶'}</span><span>${mn}ì›” ${dy}ì¼ (${dn})</span></div><span style="background:rgba(255,255,255,.3);padding:3px 10px;border-radius:12px;font-size:13px">${daySchedules.length}ê±´</span>`;
        const body = document.createElement('div');
        body.id=accordionId; body.style.display=isExp?'block':'none';
        if(isExp) body.style.animation='slideDown .3s ease-out';
        const tbl = document.createElement('div');
        tbl.style.cssText='background:#fff;border:1px solid #e0e0e0;border-radius:8px;overflow:hidden;margin-top:8px';
        const thdr=document.createElement('div');
        thdr.style.cssText='display:grid;grid-template-columns:70px 2fr 1fr 100px 140px;gap:8px;padding:11px 16px;background:#f5f5f5;font-weight:700;font-size:13px;color:#666;border-bottom:2px solid #e0e0e0';
        thdr.innerHTML='<div>ì‹œê°„</div><div>íšŒì˜ëª…</div><div>ì†ê¸°ì‚¬</div><div>ìƒíƒœ</div><div style="text-align:center">ì‘ì—…</div>';
        tbl.appendChild(thdr);
        const stCfg={unconfirmed:{color:'#ff5252',icon:'ğŸ”´',text:'ë¯¸í™•ì¸'},confirmed:{color:'#ff9800',icon:'ğŸŸ¡',text:'í™•ì¸ì™„ë£Œ'},completed:{color:'#4caf50',icon:'ğŸŸ¢',text:'ì°¸ì„ì™„ë£Œ'}};
        daySchedules.sort((a,b)=>a.time.localeCompare(b.time));
        daySchedules.forEach((s,i) => {
            const st=stCfg[s.status];
            const row=document.createElement('div');
            row.style.cssText=`display:grid;grid-template-columns:70px 2fr 1fr 100px 140px;gap:8px;padding:13px 16px;align-items:center;border-bottom:${i===daySchedules.length-1?'none':'1px solid #f0f0f0'};cursor:pointer;transition:background .2s`;
            row.onmouseover=function(){this.style.background='#f9f9f9'};
            row.onmouseout=function(){this.style.background='#fff'};
            row.innerHTML=`<div style="font-weight:600;color:#333">${s.time}</div><div><div style="font-weight:500;color:#333;margin-bottom:3px">${s.title}</div>${s.memo?`<div style="font-size:12px;color:#999">ğŸ“ ${s.memo}</div>`:''}</div><div style="color:#666">${s.freelancer_name}</div><div><span style="background:${st.color}15;color:${st.color};padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;white-space:nowrap">${st.icon} ${st.text}</span></div><div style="display:flex;gap:5px;justify-content:center"><button class="btn btn-outline" onclick="event.stopPropagation();openEditScheduleModal(${s.id})" style="font-size:11px;padding:5px 9px">ìˆ˜ì •</button><button class="btn" onclick="event.stopPropagation();deleteSchedule(${s.id})" style="font-size:11px;padding:5px 9px;background:#ffebee;color:#c62828;border:1px solid #ffcdd2">ì‚­ì œ</button></div>`;
            tbl.appendChild(row);
        });
        body.appendChild(tbl);
        hdr.onclick=()=>{ const open=body.style.display==='block'; body.style.display=open?'none':'block'; el(`arr-${accordionId}`).textContent=open?'â–¶':'â–¼'; if(!open) body.style.animation='slideDown .3s ease-out'; };
        wrap.appendChild(hdr); wrap.appendChild(body); listEl.appendChild(wrap);
    });
    updateStats();
}

// ========================
// â‘± ì¼ì • CRUD (Supabase)
// ========================
async function addSchedule(event) {
    event.preventDefault();
    const freelancerId = el('scheduleFreelancer').value;
    const sel = el('scheduleFreelancer');
    const freelancerName = sel.options[sel.selectedIndex]?.text || '';
    const title = el('scheduleTitle').value.trim();
    const memo  = el('scheduleMemo').value.trim();
    if (!selectedDates.length) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    for (const d of selectedDates) { if (!dateTimePairs[d]) { alert(`${d} ë‚ ì§œì˜ ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.`); return; } }
    // ì¤‘ë³µ ì²´í¬
    const dups = selectedDates.filter(d => schedules.some(s => s.date===d && s.freelancer_id===freelancerId && s.time===dateTimePairs[d]));
    if (dups.length && !confirm(`ë‹¤ìŒ ë‚ ì§œì— ë™ì¼ ì¼ì •ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤:\n${dups.join(', ')}\n\nê³„ì† ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    showLoading(true);
    const rows = selectedDates.map(d => ({ title, date:d, time:dateTimePairs[d], freelancer_id:freelancerId, freelancer_name:freelancerName, status:'unconfirmed', memo, created_by:currentUser.id }));
    const { data, error } = await sb.from('schedules').insert(rows).select();
    showLoading(false);
    if (error) { alert('ì¼ì • ë“±ë¡ ì˜¤ë¥˜: '+error.message); return; }
    if (data) {
        schedules.push(...data);
        // ê° ë‚ ì§œë³„ë¡œ í‘¸ì‹œ ì•Œë¦¼ (ì²« ë²ˆì§¸ ë‚ ì§œë§Œ)
        await sendPushNotification(freelancerId, `ğŸ“… ìƒˆ ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤\n${title} (${selectedDates[0]} ${dateTimePairs[selectedDates[0]]})`, 'ì†ê¸°ì‚¬ ì¼ì • ê´€ë¦¬');
    }
    showToast(`${selectedDates.length}ê±´ ë“±ë¡ ì™„ë£Œ!`);
    closeAddScheduleModal(); event.target.reset();
    if (selectedFreelancer) updateFreelancerSummary();
    renderTodaySchedules(); renderCalendar(); renderScheduleList();
}

async function saveScheduleEdit(event) {
    event.preventDefault();
    const id = parseInt(el('editScheduleId').value);
    const freelancerId = el('editScheduleFreelancer').value;
    const sel = el('editScheduleFreelancer');
    const freelancerName = sel.options[sel.selectedIndex]?.text || '';
    const updates = { title:el('editScheduleTitle').value.trim(), date:el('editScheduleDate').value, time:el('editScheduleTime').value, freelancer_id:freelancerId, freelancer_name:freelancerName, memo:el('editScheduleMemo').value.trim() };
    showLoading(true);
    const { data, error } = await sb.from('schedules').update(updates).eq('id', id).select().single();
    showLoading(false);
    if (error) { alert('ìˆ˜ì • ì˜¤ë¥˜: '+error.message); return; }
    if (data) { const idx=schedules.findIndex(s=>s.id===id); if(idx>=0) schedules[idx]=data; }
    await sendPushNotification(freelancerId, `âœï¸ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤\n${updates.title} (${updates.date} ${updates.time})`);
    showToast('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeEditScheduleModal();
    if (selectedFreelancer) updateFreelancerSummary();
    renderTodaySchedules(); renderCalendar(); renderScheduleList();
}

async function deleteSchedule(id) {
    const s = schedules.find(x=>x.id===id);
    if (!s) return;
    if (!confirm(`ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${s.title}\n${s.date} ${s.time}\n${s.freelancer_name}\n\në˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
    showLoading(true);
    const { error } = await sb.from('schedules').delete().eq('id', id);
    showLoading(false);
    if (error) { alert('ì‚­ì œ ì˜¤ë¥˜: '+error.message); return; }
    schedules = schedules.filter(x=>x.id!==id);
    await sendPushNotification(s.freelancer_id, `ğŸ—‘ï¸ ì¼ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤\n${s.title} (${s.date})`);
    showToast('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeDateDetailModal();
    if (selectedFreelancer) updateFreelancerSummary();
    renderTodaySchedules(); renderCalendar(); renderScheduleList();
}

// ========================
// â‘² ìˆ˜ì • ëª¨ë‹¬
// ========================
function openEditScheduleModal(id) {
    const s = schedules.find(x=>x.id===id);
    if (!s) return;
    el('editScheduleId').value    = id;
    el('editScheduleTitle').value = s.title;
    el('editScheduleDate').value  = s.date;
    el('editScheduleMemo').value  = s.memo||'';
    // ì†ê¸°ì‚¬ ë“œë¡­ë‹¤ìš´
    const fsel = el('editScheduleFreelancer');
    fsel.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    freelancerProfiles.forEach(p => {
        const o=document.createElement('option'); o.value=p.id; o.textContent=p.name;
        if(p.id===s.freelancer_id) o.selected=true;
        fsel.appendChild(o);
    });
    // ì‹œê°„ ë“œë¡­ë‹¤ìš´
    const tsel = el('editScheduleTime');
    tsel.innerHTML = '<option value="">ì‹œê°„ ì„ íƒ</option>';
    for (let h=6;h<=23;h++) for (let m=0;m<60;m+=30) {
        const t=`${pad(h)}:${pad(m)}`, o=document.createElement('option');
        o.value=t; o.textContent=t; if(t===s.time) o.selected=true;
        tsel.appendChild(o);
    }
    el('editScheduleModal').classList.add('show');
}
function closeEditScheduleModal() { el('editScheduleModal').classList.remove('show'); }

// ========================
// â‘³ í”„ë¦¬ëœì„œ ë·°
// ========================
function loadFreelancerSchedules() {
    const listEl = el('freelancerScheduleList'); listEl.innerHTML='';
    const todayStr = new Date().toISOString().split('T')[0];
    const mySchedules = schedules.filter(s=>s.freelancer_id===currentUser.id);
    mySchedules.sort((a,b)=>a.date.localeCompare(b.date)||a.time.localeCompare(b.time));
    mySchedules.forEach(s => {
        const isToday = s.date===todayStr;
        const ongoing = ongoingMeetings[s.id];
        const item = document.createElement('div'); item.className='schedule-item';
        let actionHTML='', timeLogHTML='';
        if (s.time_log?.endTime) {
            const wm=s.time_log.totalWorkMinutes||0;
            const fmt=t=>{const[h,m]=t.split(':');return`${h}ì‹œ ${m}ë¶„`};
            let breakInfo='ì—†ìŒ';
            if(s.time_log.breaks?.length) {
                const bm = s.time_log.totalMinutes - wm;
                if(bm>0) breakInfo=`${bm}ë¶„`;
            }
            timeLogHTML=`<div style="background:#e8f5e9;border:1px solid #4caf50;border-radius:6px;padding:12px;margin-top:10px"><div style="font-weight:700;color:#2e7d32;margin-bottom:6px">â±ï¸ íšŒì˜ ì‹œê°„ ê¸°ë¡</div><div style="font-size:13px;color:#333;line-height:1.7"><div>â€¢ ì‹œì‘: ${fmt(s.time_log.startTime)}</div><div>â€¢ ì¢…ë£Œ: ${fmt(s.time_log.endTime)}</div><div>â€¢ ì •íšŒ: ${breakInfo}</div><div style="margin-top:6px;font-weight:700;color:#1976d2">â€¢ ì‹¤ì œ ê·¼ë¬´: ${Math.floor(wm/60)}ì‹œê°„ ${wm%60}ë¶„</div></div><button class="btn btn-outline" onclick="editTimeLog(${s.id})" style="margin-top:8px;font-size:12px;padding:5px 12px">ìˆ˜ì •</button></div>`;
            actionHTML=`<span style="color:#4CAF50">âœ”ï¸ ì°¸ì„ ì™„ë£Œ</span>`;
        } else if (ongoing) {
            if (ongoing.isPaused) {
                timeLogHTML=`<div style="background:#fff9c4;border:1px solid #fbc02d;border-radius:6px;padding:10px;margin-top:10px"><div style="font-weight:700;color:#f57c00">ğŸŸ¡ ì •íšŒ ì¤‘</div></div>`;
                actionHTML=`<button class="btn btn-primary" onclick="resumeMeeting(${s.id})">â–¶ï¸ íšŒì˜ ì¬ê°œ</button><button class="btn btn-outline" onclick="endMeeting(${s.id})">â¹ï¸ íšŒì˜ ì¢…ë£Œ</button>`;
            } else {
                const elapsed = Math.floor((Date.now()-new Date(ongoing.startTime))/60000);
                timeLogHTML=`<div style="background:#e3f2fd;border:1px solid #2196f3;border-radius:6px;padding:10px;margin-top:10px"><div style="font-weight:700;color:#1976d2">ğŸŸ¢ ì§„í–‰ ì¤‘ (${elapsed}ë¶„ ê²½ê³¼)</div></div>`;
                actionHTML=`<button class="btn btn-secondary" onclick="pauseMeeting(${s.id})">â¸ï¸ ì •íšŒ</button><button class="btn btn-primary" onclick="endMeeting(${s.id})">â¹ï¸ íšŒì˜ ì¢…ë£Œ</button>`;
            }
        } else {
            if (s.status==='unconfirmed') actionHTML=`<button class="btn btn-secondary" onclick="confirmSchedule(${s.id})">âœ… ì¼ì • í™•ì¸</button>`;
            else if (s.status==='confirmed' && isToday) actionHTML=`<span style="color:#4CAF50;margin-right:8px">âœ… í™•ì¸ ì™„ë£Œ</span><button class="btn btn-primary" onclick="startMeeting(${s.id})">â–¶ï¸ íšŒì˜ ì‹œì‘</button>`;
            else if (s.status==='confirmed') actionHTML=`<span style="color:#4CAF50">âœ… í™•ì¸ ì™„ë£Œ</span>`;
        }
        item.innerHTML=`<div class="schedule-header"><div class="schedule-title">${s.title}</div></div><div class="schedule-date">ğŸ“… ${s.date} ${s.time}</div>${s.memo?`<div style="margin-top:8px;color:#666;font-size:14px">ğŸ“ ${s.memo}</div>`:''}${timeLogHTML}<div class="action-buttons">${actionHTML}</div>`;
        listEl.appendChild(item);
    });
    renderCalendar();
}

async function confirmSchedule(id) {
    showLoading(true);
    const { data, error } = await sb.from('schedules').update({ status:'confirmed' }).eq('id', id).select().single();
    showLoading(false);
    if (error) { alert('ì˜¤ë¥˜: '+error.message); return; }
    if (data) { const idx=schedules.findIndex(s=>s.id===id); if(idx>=0) schedules[idx]=data; }
    showToast('ì¼ì •ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤!');
    loadFreelancerSchedules();
}

async function startMeeting(id) {
    if (!confirm('íšŒì˜ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const now = new Date();
    const timeStr = now.toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    ongoingMeetings[id] = { startTime: now.toISOString(), breaks:[], isPaused:false };
    // DBì— ì§„í–‰ ì¤‘ ìƒíƒœ ì €ì¥
    await sb.from('schedules').update({ time_log:{ startTime:timeStr, endTime:null, breaks:[], totalMinutes:0, totalWorkMinutes:0 } }).eq('id',id);
    showToast(`íšŒì˜ ì‹œì‘: ${timeStr}`);
    loadFreelancerSchedules();
}

async function pauseMeeting(id) {
    if (!confirm('ì •íšŒë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const timeStr = new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    ongoingMeetings[id].breaks.push({ start:timeStr, end:null });
    ongoingMeetings[id].isPaused = true;
    showToast(`ì •íšŒ ì‹œì‘: ${timeStr}`);
    loadFreelancerSchedules();
}

async function resumeMeeting(id) {
    if (!confirm('íšŒì˜ë¥¼ ì¬ê°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const timeStr = new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    const ongoing = ongoingMeetings[id];
    ongoing.breaks[ongoing.breaks.length-1].end = timeStr;
    ongoing.isPaused = false;
    showToast(`íšŒì˜ ì¬ê°œ: ${timeStr}`);
    loadFreelancerSchedules();
}

async function endMeeting(id) {
    if (!confirm('íšŒì˜ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const now = new Date();
    const timeStr = now.toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    const ongoing = ongoingMeetings[id];
    const s = schedules.find(x=>x.id===id);
    if (ongoing.isPaused) ongoing.breaks[ongoing.breaks.length-1].end = timeStr;
    const startMs = new Date(ongoing.startTime);
    const totalMin = Math.floor((now-startMs)/60000);
    let breakMin=0;
    ongoing.breaks.forEach(b=>{ if(b.start&&b.end){ const bs=new Date(`${s.date} ${b.start}`),be=new Date(`${s.date} ${b.end}`); breakMin+=Math.floor((be-bs)/60000); }});
    const workMin = totalMin-breakMin;
    const startStr = startMs.toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    const timeLog = { startTime:startStr, endTime:timeStr, breaks:ongoing.breaks, totalMinutes:totalMin, totalWorkMinutes:workMin };
    showLoading(true);
    const { data, error } = await sb.from('schedules').update({ status:'completed', time_log:timeLog }).eq('id',id).select().single();
    showLoading(false);
    if (error) { alert('ì €ì¥ ì˜¤ë¥˜: '+error.message); return; }
    if (data) { const idx=schedules.findIndex(x=>x.id===id); if(idx>=0) schedules[idx]=data; }
    delete ongoingMeetings[id];
    showToast(`íšŒì˜ ì¢…ë£Œ! ì‹¤ì œ ê·¼ë¬´: ${Math.floor(workMin/60)}ì‹œê°„ ${workMin%60}ë¶„`);
    loadFreelancerSchedules();
}

function editTimeLog(id) {
    const s = schedules.find(x=>x.id===id);
    if (!s?.time_log) return;
    el('editTimeLogScheduleId').value = id;
    const [sh,sm] = s.time_log.startTime.split(':');
    const [eh,em] = s.time_log.endTime.split(':');
    el('editStartHour').value=parseInt(sh); el('editStartMinute').value=parseInt(sm);
    el('editEndHour').value=parseInt(eh); el('editEndMinute').value=parseInt(em);
    const bm = (s.time_log.totalMinutes||0)-(s.time_log.totalWorkMinutes||0);
    el('editBreakMinutes').value=bm>0?bm:0;
    el('editTimeLogModal').classList.add('show');
}
function closeEditTimeLogModal() { el('editTimeLogModal').classList.remove('show'); }

async function saveTimeLogEdit(event) {
    event.preventDefault();
    const id = parseInt(el('editTimeLogScheduleId').value);
    const s  = schedules.find(x=>x.id===id);
    if (!s) return;
    const sh=pad(el('editStartHour').value), sm=pad(el('editStartMinute').value);
    const eh=pad(el('editEndHour').value), em=pad(el('editEndMinute').value);
    const bm = parseInt(el('editBreakMinutes').value)||0;
    const newStart=`${sh}:${sm}`, newEnd=`${eh}:${em}`;
    const startMs=new Date(`${s.date} ${newStart}`), endMs=new Date(`${s.date} ${newEnd}`);
    if(endMs<=startMs){alert('ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');return;}
    const total=Math.floor((endMs-startMs)/60000);
    if(bm>=total){alert('ì •íšŒ ì‹œê°„ì´ ì „ì²´ íšŒì˜ ì‹œê°„ë³´ë‹¤ ê¸¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');return;}
    const timeLog = { startTime:newStart, endTime:newEnd, breaks:bm>0?[{start:'ì •íšŒ',end:`${bm}ë¶„`}]:[], totalMinutes:total, totalWorkMinutes:total-bm };
    showLoading(true);
    const { data, error } = await sb.from('schedules').update({ time_log:timeLog }).eq('id',id).select().single();
    showLoading(false);
    if(error){alert('ì €ì¥ ì˜¤ë¥˜: '+error.message);return;}
    if(data){const idx=schedules.findIndex(x=>x.id===id);if(idx>=0)schedules[idx]=data;}
    showToast('ì‹œê°„ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeEditTimeLogModal(); loadFreelancerSchedules();
}

// ========================
// ã‰‘ íšŒì› ê´€ë¦¬
// ========================
function renderPendingUsers() {
    const listEl=el('pendingUsersList'), countEl=el('pendingCount');
    countEl.textContent = pendingProfiles.length;
    listEl.innerHTML='';
    if (!pendingProfiles.length) { listEl.innerHTML='<div style="color:#999;padding:20px;text-align:center;background:#f9f9f9;border-radius:8px">ëŒ€ê¸° ì¤‘ì¸ ê°€ì… ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    pendingProfiles.forEach(p => {
        const c=document.createElement('div'); c.className='user-card';
        c.innerHTML=`<div class="user-card-info"><div class="user-card-name">${p.name}</div><div class="user-card-meta">ğŸ“ ${p.phone||'-'}<br>ğŸ“… ì‹ ì²­ì¼: ${new Date(p.created_at).toLocaleDateString('ko-KR')}</div></div><div class="user-card-actions"><button class="btn btn-primary" onclick="approveUser('${p.id}','${p.name}')">ìŠ¹ì¸</button><button class="btn" onclick="rejectUser('${p.id}','${p.name}')" style="background:#ffebee;color:#c62828;border:1px solid #ffcdd2">ê±°ë¶€</button></div>`;
        listEl.appendChild(c);
    });
}

function renderApprovedUsers() {
    const listEl=el('approvedUsersList'), countEl=el('approvedCount');
    countEl.textContent = freelancerProfiles.length;
    listEl.innerHTML='';
    if (!freelancerProfiles.length) { listEl.innerHTML='<div style="color:#999;padding:20px;text-align:center;background:#f9f9f9;border-radius:8px">ìŠ¹ì¸ëœ ì†ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    freelancerProfiles.forEach(p => {
        const c=document.createElement('div'); c.className='user-card';
        c.innerHTML=`<div class="user-card-info"><div class="user-card-name">${p.name} <span class="role-badge role-freelancer">ì†ê¸°ì‚¬</span></div><div class="user-card-meta">ğŸ“ ${p.phone||'-'}</div></div><div class="user-card-actions"><button class="btn btn-outline" onclick="revokeUser('${p.id}','${p.name}')">ìŠ¹ì¸ ì·¨ì†Œ</button></div>`;
        listEl.appendChild(c);
    });
}

async function approveUser(userId, name) {
    if (!confirm(`${name}ë‹˜ì˜ ê°€ì…ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    showLoading(true);
    const { error } = await sb.from('profiles').update({ approved:true }).eq('id', userId);
    showLoading(false);
    if (error) { alert('ì˜¤ë¥˜: '+error.message); return; }
    await loadProfiles();
    await sendPushNotification(userId, 'âœ… ê°€ì…ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë¡œê·¸ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    showToast(`${name}ë‹˜ ìŠ¹ì¸ ì™„ë£Œ`);
    loadFreelancerOptions();
    renderPendingUsers(); renderApprovedUsers();
}

async function rejectUser(userId, name) {
    if (!confirm(`${name}ë‹˜ì˜ ê°€ì…ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    showLoading(true);
    // ì†Œí”„íŠ¸ ì‚­ì œ: ì—­í• ì„ 'rejected'ë¡œ í‘œì‹œí•˜ê±°ë‚˜ ê·¸ëƒ¥ ì‚­ì œ
    const { error } = await sb.from('profiles').delete().eq('id', userId);
    showLoading(false);
    if (error) { alert('ì˜¤ë¥˜: '+error.message); return; }
    await loadProfiles();
    showToast(`${name}ë‹˜ ê±°ë¶€ ì²˜ë¦¬`);
    renderPendingUsers();
}

async function revokeUser(userId, name) {
    if (!confirm(`${name}ë‹˜ì˜ ì ‘ê·¼ì„ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    showLoading(true);
    const { error } = await sb.from('profiles').update({ approved:false }).eq('id', userId);
    showLoading(false);
    if (error) { alert('ì˜¤ë¥˜: '+error.message); return; }
    await loadProfiles();
    showToast(`${name}ë‹˜ ë¹„í™œì„±í™”`);
    loadFreelancerOptions(); renderApprovedUsers();
}

// ========================
// ã‰’ ìŠˆí¼ê´€ë¦¬ì - ê´€ë¦¬ì ê´€ë¦¬
// ========================
function renderAdminUsers() {
    const listEl=el('adminUsersList'), countEl=el('adminCount');
    const admins = allProfiles.filter(p=>p.role==='admin'||p.role==='superadmin');
    countEl.textContent = admins.length;
    listEl.innerHTML='';
    admins.forEach(p => {
        const isSelf = p.id===currentUser.id;
        const badge = p.role==='superadmin' ? `<span class="role-badge role-superadmin">ìŠˆí¼ê´€ë¦¬ì</span>` : `<span class="role-badge role-admin">ê´€ë¦¬ì</span>`;
        const c=document.createElement('div'); c.className='user-card';
        c.innerHTML=`<div class="user-card-info"><div class="user-card-name">${p.name} ${badge}${isSelf?' <span style="font-size:11px;color:#999">(ë‚˜)</span>':''}</div><div class="user-card-meta">ğŸ“ ${p.phone||'-'}</div></div><div class="user-card-actions">${!isSelf&&p.role==='admin'?`<button class="btn btn-outline" onclick="demoteAdmin('${p.id}','${p.name}')">ì†ê¸°ì‚¬ë¡œ ë³€ê²½</button><button class="btn btn-danger" onclick="removeAdmin('${p.id}','${p.name}')" style="font-size:13px">ì‚­ì œ</button>`:''}${!isSelf&&p.role==='superadmin'?`<button class="btn btn-outline" onclick="demoteAdmin('${p.id}','${p.name}')">ê´€ë¦¬ìë¡œ ë³€ê²½</button>`:''}`;
        listEl.appendChild(c);
    });
}

async function promoteToAdmin() {
    const userId = el('promoteFreelancerSelect').value;
    if (!userId) { alert('ì†ê¸°ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
    const p = allProfiles.find(x=>x.id===userId);
    if (!confirm(`${p?.name}ë‹˜ì„ ê´€ë¦¬ìë¡œ ìŠ¹ê²©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    showLoading(true);
    const { error } = await sb.from('profiles').update({ role:'admin', approved:true }).eq('id', userId);
    showLoading(false);
    if (error) { alert('ì˜¤ë¥˜: '+error.message); return; }
    await loadProfiles(); showToast(`${p?.name}ë‹˜ì´ ê´€ë¦¬ìë¡œ ìŠ¹ê²©ë˜ì—ˆìŠµë‹ˆë‹¤`);
    closeAddAdminModal(); renderAdminUsers();
}

async function demoteAdmin(userId, name) {
    if (!confirm(`${name}ë‹˜ì„ ì†ê¸°ì‚¬ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    showLoading(true);
    const { error } = await sb.from('profiles').update({ role:'freelancer', approved:true }).eq('id', userId);
    showLoading(false);
    if (error) { alert('ì˜¤ë¥˜: '+error.message); return; }
    await loadProfiles(); showToast(`${name}ë‹˜ì´ ì†ê¸°ì‚¬ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);
    renderAdminUsers();
}

async function removeAdmin(userId, name) {
    if (!confirm(`${name}ë‹˜ì˜ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
    showLoading(true);
    const { error } = await sb.from('profiles').delete().eq('id', userId);
    showLoading(false);
    if (error) { alert('ì˜¤ë¥˜: '+error.message); return; }
    await loadProfiles(); showToast(`${name}ë‹˜ ê³„ì • ì‚­ì œ`);
    renderAdminUsers();
}

function openAddAdminModal() {
    const sel = el('promoteFreelancerSelect');
    sel.innerHTML='<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    freelancerProfiles.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o); });
    el('addAdminModal').classList.add('show');
}
function closeAddAdminModal() { el('addAdminModal').classList.remove('show'); }

// ========================
// ã‰“ ì¼ì • ë“±ë¡ ëª¨ë‹¬ / ë‚ ì§œ ì„ íƒ
// ========================
function loadFreelancerOptions() {
    const schedSel=el('scheduleFreelancer'), adminSel=el('adminFreelancerSelect');
    if(schedSel){ schedSel.innerHTML='<option value="">ì„ íƒí•˜ì„¸ìš”</option>'; freelancerProfiles.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; schedSel.appendChild(o); }); }
    if(adminSel){ const cv=adminSel.value; adminSel.innerHTML='<option value="">ì „ì²´ ë³´ê¸°</option>'; freelancerProfiles.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; adminSel.appendChild(o); }); if(cv) adminSel.value=cv; }
}

function openAddScheduleModal() {
    el('addScheduleModal').classList.add('show');
    selectedDates=[]; dateTimePairs={}; bulkDate=new Date();
    loadFreelancerOptions(); renderBulkDateSelector(); updateSelectedDatesDisplay();
    el('scheduleTitle').value=''; el('scheduleMemo').value='';
    el('timeSettingsContainer').style.display='none';
}
function closeAddScheduleModal() { el('addScheduleModal').classList.remove('show'); selectedDates=[]; dateTimePairs={}; el('timeSettingsContainer').style.display='none'; }

function updateFreelancerSuggestions() {
    const ml=el('meetingList'); ml.innerHTML='';
    meetingTitlesHistory.forEach(t=>{ const o=document.createElement('option'); o.value=t; ml.appendChild(o); });
}

function renderBulkDateSelector() {
    const year=bulkDate.getFullYear(), month=bulkDate.getMonth();
    el('bulkMonthDisplay').textContent=`${year}ë…„ ${month+1}ì›”`;
    const gridEl=el('bulkDateSelector'); gridEl.innerHTML='';
    ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d=>{ const h=document.createElement('div'); h.style.cssText='text-align:center;font-weight:700;color:#666;font-size:12px;padding:5px'; h.textContent=d; gridEl.appendChild(h); });
    const firstDay=new Date(year,month,1).getDay(), lastDate=new Date(year,month+1,0).getDate();
    for(let i=0;i<firstDay;i++) gridEl.appendChild(document.createElement('div'));
    for(let d=1;d<=lastDate;d++){
        const dateStr=`${year}-${pad(month+1)}-${pad(d)}`, isSel=selectedDates.includes(dateStr);
        const btn=document.createElement('div');
        btn.style.cssText=`padding:8px;text-align:center;border:2px solid ${isSel?'#4CAF50':'#ddd'};background:${isSel?'#e8f5e9':'#fff'};border-radius:6px;cursor:pointer;font-size:14px;transition:all .2s;-webkit-tap-highlight-color:transparent`;
        btn.textContent=d;
        btn.onclick=()=>toggleDateSelection(dateStr);
        gridEl.appendChild(btn);
    }
}

function toggleDateSelection(dateStr) {
    const idx=selectedDates.indexOf(dateStr);
    if(idx>-1){ selectedDates.splice(idx,1); delete dateTimePairs[dateStr]; }
    else { selectedDates.push(dateStr); selectedDates.sort(); dateTimePairs[dateStr]=''; }
    renderBulkDateSelector(); updateSelectedDatesDisplay(); renderTimeSettings();
}

function updateSelectedDatesDisplay() {
    const d=el('selectedDatesDisplay');
    if(!selectedDates.length){ d.textContent='ì—†ìŒ'; d.style.color='#999'; d.style.fontWeight='normal'; return; }
    d.textContent=selectedDates.map(s=>{ const dt=new Date(s+'T00:00:00'); return `${dt.getMonth()+1}/${dt.getDate()}`; }).join(', ')+` (${selectedDates.length}ê°œ)`;
    d.style.color='#4CAF50'; d.style.fontWeight='700';
}

function renderTimeSettings() {
    const container=el('timeSettingsContainer'), listEl=el('timeSettingsList');
    if(!selectedDates.length){ container.style.display='none'; return; }
    container.style.display='block'; listEl.innerHTML='';
    selectedDates.forEach(dateStr=>{
        const dt=new Date(dateStr+'T00:00:00'), label=`${dt.getMonth()+1}ì›” ${dt.getDate()}ì¼`;
        const row=document.createElement('div'); row.style.cssText='display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:10px;background:#fff;border-radius:6px';
        row.innerHTML=`<div style="flex:1;font-weight:500;color:#333">${label}</div><select onchange="updateDateTime('${dateStr}',this.value)" required style="flex:2;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px"><option value="">ì‹œê°„ ì„ íƒ</option>${genTimeOpts(dateStr)}</select>`;
        listEl.appendChild(row);
    });
}

function genTimeOpts(dateStr) {
    let html=''; const cur=dateTimePairs[dateStr]||'';
    for(let h=6;h<=23;h++) for(let m=0;m<60;m+=30){ const t=`${pad(h)}:${pad(m)}`; html+=`<option value="${t}"${t===cur?' selected':''}>${t}</option>`; }
    return html;
}

function updateDateTime(dateStr, time) { dateTimePairs[dateStr]=time; }
function changeBulkMonth(delta) { bulkDate.setMonth(bulkDate.getMonth()+delta); renderBulkDateSelector(); }

// ========================
// ã‰” ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ìº˜ë¦°ë” í˜•ì‹)
// ========================
function downloadExcel() {
    const year=currentDate.getFullYear(), month=currentDate.getMonth();
    let arr=schedules.filter(s=>{ const d=new Date(s.date+'T00:00:00'); return d.getFullYear()===year&&d.getMonth()===month; });
    if(selectedFreelancer) arr=arr.filter(s=>s.freelancer_id===selectedFreelancer);
    if(!arr.length && !confirm(`${year}ë…„ ${month+1}ì›” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. ë¹ˆ ìº˜ë¦°ë”ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, buildCalendarSheet(year,month,arr), `${month+1}ì›”_ìº˜ë¦°ë”`);
    XLSX.utils.book_append_sheet(wb, buildFreelancerSheet(year,month,arr), 'ì†ê¸°ì‚¬ë³„_ì •ë¦¬');
    const today=new Date(), ts=`${today.getFullYear()}${pad(today.getMonth()+1)}${pad(today.getDate())}`;
    let fn=`ì†ê¸°ì‚¬_ì¶œì¥ì¼ì •_${year}${pad(month+1)}`;
    if(selectedFreelancer){ const p=freelancerProfiles.find(x=>x.id===selectedFreelancer); fn+=`_${p?.name||''}`; }
    XLSX.writeFile(wb, `${fn}_${ts}.xlsx`);
    showToast(`${year}ë…„ ${month+1}ì›” ìº˜ë¦°ë” ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`);
}

function buildCalendarSheet(year, month, arr) {
    const byDate={};
    arr.forEach(s=>{ if(!byDate[s.date]) byDate[s.date]=[]; byDate[s.date].push(s); });
    Object.values(byDate).forEach(a=>a.sort((x,y)=>x.time.localeCompare(y.time)));
    const stMark={unconfirmed:'â–²',confirmed:'â—',completed:'â˜…'};
    const aoa=[], merges=[];
    aoa.push([`${year}ë…„ ${month+1}ì›” ì†ê¸°ì‚¬ ì¶œì¥ ì¼ì •`,'','','','','','']);
    merges.push({s:{r:0,c:0},e:{r:0,c:6}});
    aoa.push(['â–²ë¯¸í™•ì¸  â—í™•ì¸ì™„ë£Œ  â˜…ì°¸ì„ì™„ë£Œ','','','','','','']);
    merges.push({s:{r:1,c:0},e:{r:1,c:6}});
    aoa.push(['','','','','','','']);
    aoa.push(['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ']);
    const first=new Date(year,month,1).getDay(), last=new Date(year,month+1,0).getDate();
    let date=1, isFirst=true;
    while(date<=last){
        const week=[];
        for(let c=0;c<7;c++){
            if(isFirst&&c<first) week.push(null);
            else if(date>last) week.push(null);
            else { const ds=`${year}-${pad(month+1)}-${pad(date)}`; week.push({date,ds,schedules:byDate[ds]||[]}); date++; }
        }
        isFirst=false;
        aoa.push(week.map(d=>d?`${d.date}ì¼`:''));
        const mx=Math.max(...week.map(d=>d?d.schedules.length:0),0);
        for(let i=0;i<mx;i++) aoa.push(week.map(d=>{ if(!d||i>=d.schedules.length) return ''; const s=d.schedules[i]; return `${stMark[s.status]||''}[${s.time}] ${s.freelancer_name}-${s.title}`; }));
        aoa.push(['','','','','','','']);
    }
    const ws=XLSX.utils.aoa_to_sheet(aoa); ws['!cols']=Array(7).fill({wch:28}); ws['!merges']=merges; return ws;
}

function buildFreelancerSheet(year, month, arr) {
    const dayNames=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    let fls = selectedFreelancer ? freelancerProfiles.filter(p=>p.id===selectedFreelancer) : [...freelancerProfiles].sort((a,b)=>a.name.localeCompare(b.name,'ko'));
    const aoa=[['ë‚ ì§œ','ìš”ì¼',...fls.map(f=>f.name)]];
    const last=new Date(year,month+1,0).getDate();
    for(let d=1;d<=last;d++){
        const ds=`${year}-${pad(month+1)}-${pad(d)}`, dow=new Date(ds+'T00:00:00').getDay();
        const row=[ds,dayNames[dow]];
        fls.forEach(f=>{ const fl=arr.filter(s=>s.date===ds&&s.freelancer_id===f.id); row.push(fl.length?fl.map(s=>`${s.title}(${s.time})`).join(' / '):''); });
        aoa.push(row);
    }
    const ws=XLSX.utils.aoa_to_sheet(aoa); ws['!cols']=[{wch:12},{wch:5},...fls.map(()=>({wch:22}))]; return ws;
}

// ========================
// ã‰• ìœ í‹¸ë¦¬í‹°
// ========================
function el(id) { return document.getElementById(id); }
function show(id) { const e=el(id); if(e) e.style.display='block'; }
function hide(id) { const e=el(id); if(e) e.style.display='none'; }
function pad(n) { return String(n).padStart(2,'0'); }

function showLoading(v) { el('loadingOverlay').classList.toggle('show', v); }

function showToast(msg) {
    const t=el('toast'); t.textContent=msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2800);
}

function showFieldError(fieldId, msg) {
    const e=el(fieldId); if(!e) return;
    e.textContent=msg; e.classList.add('show');
}
function clearFieldError(fieldId) { const e=el(fieldId); if(e) e.classList.remove('show'); }
</script>
</body>
</html>
